using Radar_Project.Controls;
using System;
using System.Net;
using System.Windows;
using System.Windows.Threading;

namespace Radar_Project
{
    /// <summary>
    /// Interaction logic for MainWindow.xaml
    /// </summary>
    public partial class MainWindow : Window
    {
        private DispatcherTimer timer;        
        //for simulation array
        int[,] tg;
        int[] simTargetIndex;       

        Target[] target = new Target[2];
        Double[] range = new Double[2];

        public MainWindow()
        {
            InitializeComponent();

            for (int i = 0; i < target.Length; i++)
            {
                target[i] = new Target(i + 1);                
            }
               

            targetsListView.ItemsSource = radarControl.Targets;
           

            btnSimStop.IsEnabled = false;
           // btnRadarStop.IsEnabled = false;
            simMode.IsEnabled = false;

            radarControl.Range = int.Parse(cmbRange.Text.ToString());

            radarControl.RadarTargetUpdated += RadarControl_RadarTargetUpdated;
           
        }

        private void RadarControl_RadarTargetUpdated(object sender, EventArgs e)
        {
            targetsListView.Items.Refresh();
        }
       

        private void btnSet_Click(object sender, RoutedEventArgs e)
        {
            var range = int.Parse(cmbRange.Text.ToString());
            if (radarControl.Range != range)
            {
                radarControl.Range = range;

                radarControl.InvalidateVisual();    //Invalidates the rendering of the element, and forces a complete new layout pass. 
                                                    //OnRender(DrawingContext) is called after the layout cycle is completed.
            }
            double cal;

            var cal_flag = double.TryParse(txtboxNorth.Text, out cal);
            if (cal < 360 && cal >= 0)
            {
                radarControl.Cal = cal;

                radarControl.SectorScan();
            }
            else
                MessageBox.Show("North Calibration should be 0 to 359 !!!");
        }

        private void Window_Closed(object sender, EventArgs e)
        {
            if (btnRadarStop.IsEnabled == true)
                radarControl.Disconnect();
        }

        private void btnRadarStart_Click(object sender, RoutedEventArgs e)
        {
            radarControl.CreateRadarInstance();
           
        }

        private void btnRadarStop_Click(object sender, RoutedEventArgs e)
        {
            radarControl.Disconnect();
            radarControl.StopAnimation();
            radarControl.Online = false;
        }

        private void choiceMode_Changed(object sender, RoutedEventArgs e)
        {
            if (!this.IsInitialized)
                return;

            if (rbtn_one.IsChecked.Value)
            {
                simMode.IsEnabled = false;
                radarMode.IsEnabled = true;

                if (timer != null)
                    btnSimStop_Click(null, null);
            }
            else
            {
                simMode.IsEnabled = true;
                radarMode.IsEnabled = false;

                if(radarControl.Online)
                    btnRadarStop_Click(null,null);
            }

        }

        private void UpdateListView()
        {
            this.targetsListView.ItemsSource = radarControl.Targets;
            
        }

        #region Simulation
        private void SimulationValues()
        {
            simTargetIndex = new int[6];
            simTargetIndex[1] = 450;

            //for simulation array
            tg = new int[500,2]
            {
            {3, 17}, //0
            {3, 17}, //1
            {3, 17}, //2
            {3, 12}, //3
            {3, 12}, //4
            {3, 12}, //5
            {3, 355}, //6
            {3, 355}, //7
            {3, 355}, //8
            {4, 347}, //9
            {4, 347}, //10
            {4, 333}, //11
            {5, 333}, //12
            {5, 333}, //13
            {6, 333}, //14
            {6, 333}, //15
            {6, 333}, //16
            {6, 333}, //17
            {6, 332}, //18
            {6, 332}, //19
            {6, 332}, //20
            {7, 330}, //21
            {7, 330}, //22
            {8, 330}, //23
            {8, 330}, //24
            {8, 330}, //25
            {8, 330}, //26
            {8, 330}, //27
            {9, 330}, //28
            {9, 330}, //29
            {10, 328}, //30
            {10, 328}, //31
            {10, 328}, //32
            {10, 328}, //33
            {10, 328}, //34
            {10, 328}, //35
            {11, 328}, //36
            {11, 328}, //37
            {11, 327}, //38
            {12, 329}, //39
            {12, 329}, //40
            {13, 327}, //41
            {13, 327}, //42
            {13, 327}, //43
            {13, 327}, //44
            {14, 326}, //45
            {14, 327}, //46
            {14, 326}, //47
            {14, 326}, //48
            {15, 326}, //49
            {16, 327}, //50
            {16, 327}, //51
            {16, 327}, //52
            {16, 327}, //53
            {16, 327}, //54
            {16, 327}, //55
            {16, 326}, //56
            {16, 326}, //57
            {16, 326}, //58
            {17, 327}, //59
            {17, 328}, //60
            {18, 329}, //61
            {18, 328}, //62
            {18, 328}, //63
            {19, 329}, //64
            {19, 329}, //65
            {20, 329}, //66
            {20, 329}, //67
            {20, 329}, //68
            {20, 329}, //69
            {21, 331}, //70
            {22, 331}, //71
            {22, 332}, //72
            {23, 333}, //73
            {23, 333}, //74
            {24, 333}, //75
            {24, 333}, //76
            {24, 334}, //77
            {25, 334}, //78
            {26, 332}, //79
            {26, 332}, //80
            {27, 333}, //81
            {29, 332}, //82
            {30, 332}, //83
            {30, 332}, //84
            {30, 333}, //85
            {31, 333}, //86
            {31, 332}, //87
            {32, 333}, //88
            {32, 333}, //89
            {34, 333}, //90
            {34, 333}, //91
            {34, 333}, //92
            {34, 334}, //93
            {34, 334}, //94
            {36, 334}, //95
            {37, 334}, //96
            {37, 335}, //97
            {38, 335}, //98
            {39, 336}, //99
            {41, 336}, //100
            {41, 336}, //101
            {43, 336}, //102
            {45, 337}, //103
            {45, 337}, //104
            {47, 337}, //105
            {47, 337}, //106
            {49, 338}, //107
            {49, 338}, //108
            {50, 338}, //109
            {50, 338}, //110
            {51, 338}, //111
            {51, 339}, //112
            {52, 339}, //113
            {53, 339}, //114
            {54, 339}, //115
            {55, 340}, //116
            {56, 340}, //117
            {57, 340}, //118
            {57, 340}, //119
            {59, 341}, //120
            {60, 341}, //121
            {61, 341}, //122
            {61, 341}, //123
            {61, 341}, //124
            {62, 341}, //125
            {62, 341}, //126
            {63, 342}, //127
            {65, 341}, //128
            {65, 341}, //129
            {65, 341}, //130
            {66, 342}, //131
            {66, 342}, //132
            {69, 342}, //133
            {70, 343}, //134
            {70, 343}, //135
            {71, 343}, //136
            {72, 343}, //137
            {72, 343}, //138
            {72, 343}, //139
            {74, 344}, //140
            {74, 344}, //141
            {75, 344}, //142
            {75, 344}, //143
            {77, 344}, //144
            {77, 344}, //145
            {77, 344}, //146
            {78, 344}, //147
            {78, 344}, //148
            {79, 345}, //149
            {79, 345}, //150
            {80, 345}, //151
            {80, 345}, //152
            {80, 345}, //153
            {82, 345}, //154
            {82, 345}, //155
            {83, 345}, //156
            {83, 346}, //157
            {84, 346}, //158
            {85, 346}, //159
            {85, 346}, //160
            {85, 346}, //161
            {85, 346}, //162
            {85, 346}, //163
            {85, 347}, //164
            {85, 347}, //165
            {86, 347}, //166
            {86, 347}, //167
            {86, 347}, //168
            {87, 348}, //169
            {89, 352}, //170
            {89, 352}, //171
            {90, 352}, //172
            {91, 353}, //173
            {91, 353}, //174
            {91, 353}, //175
            {91, 354}, //176
            {92, 354}, //177
            {92, 354}, //178
            {91, 355}, //179
            {91, 355}, //180
            {92, 355}, //181
            {92, 356}, //182
            {92, 357}, //183
            {92, 357}, //184
            {92, 357}, //185
            {92, 357}, //186
            {92, 357}, //187
            {92, 358}, //188
            {92, 359}, //189
            {92, 359}, //190
            {92, 1}, //191
            {92, 2}, //192
            {92, 3}, //193
            {92, 3}, //194
            {92, 4}, //195
            {92, 5}, //196
            {91, 5}, //197
            {92, 6}, //198
            {92, 6}, //199
            {92, 7}, //200
            {92, 8}, //201
            {92, 8}, //202
            {91, 8}, //203
            {91, 8}, //204
            {91, 9}, //205
            {91, 9}, //206
            {90, 9}, //207
            {90, 9}, //208
            {90, 10}, //209
            {90, 10}, //210
            {90, 10}, //211
            {90, 10}, //212
            {90, 10}, //213
            {90, 10}, //214
            {89, 10}, //215
            {89, 10}, //216
            {89, 11}, //217
            {89, 11}, //218
            {87, 12}, //219
            {87, 12}, //220
            {86, 12}, //221
            {86, 12}, //222
            {86, 13}, //223
            {86, 13}, //224
            {85, 13}, //225
            {85, 13}, //226
            {85, 14}, //227
            {85, 14}, //228
            {85, 14}, //229
            {85, 14}, //230
            {84, 15}, //231
            {83, 15}, //232
            {84, 16}, //233
            {83, 16}, //234
            {83, 16}, //235
            {83, 17}, //236
            {82, 18}, //237
            {82, 18}, //238
            {82, 20}, //239
            {82, 20}, //240
            {81, 21}, //241
            {80, 23}, //242
            {80, 23}, //243
            {79, 25}, //244
            {80, 27}, //245
            {80, 27}, //246
            {79, 28}, //247
            {80, 30}, //248
            {79, 31}, //249
            {79, 31}, //250
            {80, 32}, //251
            {80, 32}, //252
            {80, 32}, //253
            {80, 32}, //254
            {81, 32}, //255
            {82, 34}, //256
            {82, 34}, //257
            {83, 35}, //258
            {83, 35}, //259
            {84, 36}, //260
            {84, 37}, //261
            {85, 37}, //262
            {85, 38}, //263
            {86, 38}, //264
            {86, 39}, //265
            {87, 40}, //266
            {87, 40}, //267
            {87, 40}, //268
            {88, 41}, //269
            {88, 41}, //270
            {89, 41}, //271
            {89, 41}, //272
            {89, 42}, //273
            {90, 42}, //274
            {90, 42}, //275
            {90, 42}, //276
            {92, 43}, //277
            {96, 43}, //278
            {96, 43}, //279
            {96, 43}, //280
            {96, 43}, //281
            {96, 43}, //282
            {96, 43}, //283
            {96, 43}, //284
            {96, 43}, //285
            {96, 43}, //286
            {96, 43}, //287
            {96, 43}, //288
            {96, 43}, //289
            {96, 43}, //290
            {96, 43}, //291
            {96, 43}, //292
            {96, 43}, //293
            {96, 43}, //294
            {96, 43}, //295
            {96, 42}, //296
            {96, 42}, //297
            {96, 42}, //298
            {96, 42}, //299
            {96, 42}, //300
            {96, 42}, //301
            {96, 42}, //302
            {95, 42}, //303
            {95, 42}, //304
            {95, 42}, //305
            {95, 42}, //306
            {95, 42}, //307
            {95, 42}, //308
            {95, 42}, //309
            {95, 42}, //310
            {95, 42}, //311
            {95, 42}, //312
            {95, 42}, //313
            {95, 41}, //314
            {95, 41}, //315
            {95, 41}, //316
            {95, 40}, //317
            {95, 40}, //318
            {95, 40}, //319
            {95, 40}, //320
            {95, 40}, //321
            {95, 40}, //322
            {95, 40}, //323
            {95, 40}, //324
            {95, 40}, //325
            {95, 40}, //326
            {95, 40}, //327
            {95, 40}, //328
            {95, 40}, //329
            {95, 40}, //330
            {94, 40}, //331
            {94, 40}, //332
            {94, 40}, //333
            {94, 40}, //334
            {94, 40}, //335
            {94, 40}, //336
            {94, 40}, //337
            {94, 40}, //338
            {94, 40}, //339
            {94, 39}, //340
            {93, 39}, //341
            {93, 38}, //342
            {93, 37}, //343
            {93, 36}, //344
            {93, 36}, //345
            {93, 36}, //346
            {93, 36}, //347
            {93, 36}, //348
            {93, 36}, //349
            {93, 36}, //350
            {93, 36}, //351
            {93, 36}, //352
            {93, 36}, //353
            {93, 36}, //354
            {92, 36}, //355
            {92, 35}, //356
            {92, 35}, //357
            {92, 35}, //358
            {92, 35}, //359
            {92, 34}, //360
            {92, 34}, //361
            {91, 34}, //362
            {91, 33}, //363
            {91, 33}, //364
            {91, 33}, //365
            {90, 32}, //366
            {89, 31}, //367
            {88, 30}, //368
            {87, 29}, //369
            {86, 29}, //370
            {85, 29}, //371
            {84, 28}, //372
            {84, 28}, //373
            {84, 28}, //374
            {84, 28}, //375
            {84, 28}, //376
            {84, 28}, //377
            {84, 28}, //378
            {84, 28}, //379
            {84, 28}, //380
            {83, 28}, //381
            {83, 28}, //382
            {83, 28}, //383
            {83, 28}, //384
            {83, 28}, //385
            {83, 28}, //386
            {83, 28}, //387
            {83, 28}, //388
            {83, 28}, //389
            {83, 28}, //390
            {83, 28}, //391
            {82, 28}, //392
            {82, 29}, //393
            {81, 29}, //394
            {81, 29}, //395
            {80, 29}, //396
            {79, 29}, //397
            {78, 29}, //398
            {77, 30}, //399
            {76, 30}, //400
            {75, 30}, //401
            {75, 30}, //402
            {75, 30}, //403
            {74, 30}, //404
            {74, 30}, //405
            {73, 29}, //406
            {72, 30}, //407
            {72, 30}, //408
            {72, 30}, //409
            {72, 30}, //410
            {72, 30}, //411
            {71, 30}, //412
            {71, 30}, //413
            {70, 31}, //414
            {70, 31}, //415
            {69, 31}, //416
            {69, 31}, //417
            {69, 31}, //418
            {69, 31}, //419
            {68, 31}, //420
            {67, 32}, //421
            {67, 32}, //422
            {66, 31}, //423
            {66, 31}, //424
            {66, 31}, //425
            {65, 32}, //426
            {64, 32}, //427
            {63, 33}, //428
            {62, 33}, //429
            {62, 33}, //430
            {61, 33}, //431
            {60, 33}, //432
            {60, 33}, //433
            {60, 33}, //434
            {58, 33}, //435
            {58, 33}, //436
            {56, 33}, //437
            {56, 33}, //438
            {55, 33}, //439
            {54, 33}, //440
            {54, 33}, //441
            {53, 33}, //442
            {52, 34}, //443
            {52, 34}, //444
            {52, 34}, //445
            {51, 34}, //446
            {51, 34}, //447
            {51, 34}, //448
            {47, 33}, //449
            {47, 33}, //450
            {47, 33}, //451
            {46, 33}, //452
            {45, 33}, //453
            {45, 33}, //454
            {45, 33}, //455
            {45, 33}, //456
            {42, 32}, //457
            {41, 31}, //458
            {41, 31}, //459
            {39, 30}, //460
            {39, 30}, //461
            {39, 29}, //462
            {38, 29}, //463
            {37, 28}, //464
            {37, 28}, //465
            {36, 27}, //466
            {36, 27}, //467
            {35, 25}, //468
            {35, 24}, //469
            {35, 24}, //470
            {34, 24}, //471
            {34, 22}, //472
            {34, 22}, //473
            {33, 21}, //474
            {32, 19}, //475
            {32, 19}, //476
            {32, 19}, //477
            {32, 19}, //478
            {32, 18}, //479
            {32, 18}, //480
            {32, 16}, //481
            {32, 16}, //482
            {31, 15}, //483
            {31, 14}, //484
            {30, 13}, //485
            {30, 13}, //486
            {30, 11}, //487
            {30, 11}, //488
            {30, 11}, //489
            {30, 9}, //490
            {30, 9}, //491
            {30, 9}, //492
            {30, 9}, //493
            {30, 7}, //494
            {30, 7}, //495
            {30, 5}, //496
            {30, 5}, //497
            {29, 4}, //498
            {29, 1} //499
            };           

            timer = new DispatcherTimer();
            timer.Tick += Timer_Tick;
            timer.Interval = new TimeSpan(1000000);              
            timer.Start();
        }
        private void Timer_Tick(object sender, EventArgs e)
        {
            CreateTargets();

            targetsListView.Items.Refresh();
           
        }      

        private void btnSimStart_Click(object sender, RoutedEventArgs e)
        {
            UpdateListView();
            
            SimulationValues();

            radarControl.StartAnimation();

            SimBtnIsEnable(true);
        }

        private void btnSimStop_Click(object sender, RoutedEventArgs e)
        {
            radarControl.StopAnimation();

            timer.Stop();
            timer = null;
            
            
            targetsListView.ItemsSource = null;
            targetsListView.Items.Clear();
            radarControl.Targets.Clear();
            
            radarControl.ClearPPITargets();

            SimBtnIsEnable(false);

            for(int i=0; i< target.Length; i++)
            {
               
                target[i].TrackPoints.Clear();
            }
            
        }

        private void SimBtnIsEnable(bool flag)
        {
            btnSimStop.IsEnabled = flag;
            btnSimStart.IsEnabled = !flag;
        }

        private void CreateTargets()
        {           
            

            for(int i=0; i< target.Length; i++)
            {               
                target[i].Depart = false;
                target[i].Azimuth = tg[simTargetIndex[i], 1];
                target[i].Distance = tg[simTargetIndex[i], 0];

                ApprochFunc(target[i], ref range[i]);

                if (i == 0)
                {
                    if ((++simTargetIndex[0]) >= 500)
                        simTargetIndex[0] = 0;
                }
                else
                {
                    if ((--simTargetIndex[1]) <= 50)
                        simTargetIndex[1] = 450;
                }

              radarControl.AddItem(target[i]);

            }
           
        }

        private void ApprochFunc(Target target, ref double range)
        {
            if (target.Distance < range)
            {
                target.Approach = true;
            }
            else if (target.Distance > range)
                target.Approach = false;

             range = target.Distance;

        }

        #endregion
    }
}
